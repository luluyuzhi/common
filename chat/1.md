### 数据同步

**为什么一个新登录的微信找不到聊天记录？**

微信服务器端为每一份需要与客户端同步的数据（例如聊天消息）都会赋予一个唯一的、递增的序列号（后文称为 sequence ），**作为这份数据的版本号（这是利用了序列号递增的特性）。在客户端与服务器端同步的时候，客户端会带上已经同步下去数据的最大版本号，后台会根据客户端最大版本号与服务器端的最大版本号，计算出需要同步的增量数据，返回给客户端。**这样不仅保证了客户端与服务器端的数据同步的可靠性，同时也大幅减少了同步时的冗余数据（就像这篇文章中讨论的一样：《[如何保证IM实时消息的“时序性”与“一致性”？](https://link.zhihu.com/?target=http%3A//www.52im.net/thread-714-1-1.html)》）。



**如何实现具有一下两点的序列号：**

1）递增的64位整型变量；

2）每个用户都有自己独立的64位 sequence 空间。

**很大原因是全局唯一的 sequence 会有非常严重的申请互斥问题，不容易去实现一个高性能高可靠的架构。对微信业务来说，每个用户独立的64位 sequence 空间已经满足业务要求。**

